# 交換留学生システム 404エラー原因分析レポート

## 1. 概要

本レポートは、交換留学生システムのVercelデプロイ時に発生する404エラーの根本原因を分析し、優先順位付きで解決策を提示するものである。

## 2. エラーの背景

### 2.1 システム構成
- **フロントエンド**: React SPA (Single Page Application)
- **バックエンド**: Express.js API (Vercel Serverless Functions)
- **データベース**: PostgreSQL (Supabase)
- **デプロイ環境**: Vercel

### 2.2 アーキテクチャの問題
現在のシステムはモノレポ構造を採用しており、APIとクライアントが同じリポジトリに配置されている。この構成により、ビルド順序やルーティング設定に複雑性が生じている。

## 3. 404エラーの根本原因（優先順位順）

### 3.1 最優先 (Critical) - 即座に修正が必要

#### 3.1.1 Vercel設定のルーティング競合
**問題**: vercel.jsonのrewrites設定において、ワイルドカードパターンがAPIルートを上書きしている。

```json
"rewrites": [
  {
    "source": "/(.*)",  // すべてのリクエストをキャッチ
    "destination": "/client/build/index.html"
  },
  {
    "source": "/api/(.*)",  // このルールが実行されない
    "destination": "/api/index.js"
  }
]
```

**影響度**: 100% - APIが完全に動作しない
**解決策**: ルートの順序を変更し、より具体的なAPIルートを先に定義する。

#### 3.1.2 ビルド出力パスの不一致
**問題**: vercel.jsonで指定されたdistDirと実際のビルド出力パスが一致していない。

```json
"config": {
  "distDir": "build"  // 実際のビルド出力と異なる可能性
}
```

**影響度**: 90% - 静的ファイルが404エラー
**解決策**: 実際のビルド出力パスを確認し、設定を修正する。

### 3.2 高優先 (High) - 24時間以内に修正

#### 3.2.1 React SPAルーティングの欠如
**問題**: 現在のアプリケーションはReact Routerを使用しておらず、サーバーサイドルーティングが実装されていない。

```javascript
function App() {
  const [currentPage, setCurrentPage] = useState('login');
  // サーバーサイドルーティングなし
}
```

**影響度**: 80% - 直接URLアクセスで404エラー
**解決策**: React Routerを導入し、適切なルーティング設定を実装する。

#### 3.2.2 APIパスの解決エラー
**問題**: 本番環境でのAPIパスが相対パスで指定されており、正しく解決されない。

```javascript
const getApiBaseUrl = () => {
  if (process.env.NODE_ENV === 'production') {
    return '/api';  // 相対パスが正しく解決されない
  }
  return 'http://localhost:5000/api';
};
```

**影響度**: 75% - API呼び出しが失敗
**解決策**: 絶対パスを使用し、window.location.originを活用する。

#### 3.2.3 静的ファイルのパス設定
**問題**: vercel.jsonの静的ファイルルーティングが実際のビルド出力パスと一致していない。

```json
"routes": [
  {
    "src": "/static/(.*)",
    "dest": "/client/build/static/$1"  // 実際のパスと異なる
  }
]
```

**影響度**: 70% - CSS/JSファイルが読み込まれない
**解決策**: 実際のビルド出力パスに合わせて設定を修正する。

### 3.3 中優先 (Medium) - 1週間以内に修正

#### 3.3.1 ビルドプロセスの失敗
**問題**: メモリ制限や依存関係の問題によりビルドが失敗している可能性がある。

```json
"scripts": {
  "build": "GENERATE_SOURCEMAP=false react-scripts build"
}
```

**影響度**: 60% - ビルドが失敗してファイルが存在しない
**解決策**: ビルド設定の最適化とメモリ使用量の削減。

#### 3.3.2 環境変数の未設定
**問題**: Vercelで必要な環境変数が設定されていない。

```javascript
const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';
```

**影響度**: 50% - 認証機能が動作しない
**解決策**: Vercelダッシュボードで環境変数を適切に設定する。

#### 3.3.3 CORS設定の問題
**問題**: 過度に寛容なCORS設定により、ブラウザでAPI呼び出しがブロックされる可能性がある。

```javascript
app.use(cors());  // 過度に寛容
```

**影響度**: 45% - ブラウザでAPI呼び出しがブロック
**解決策**: 適切なCORS設定を実装する。

### 3.4 低優先 (Low) - 1ヶ月以内に修正

#### 3.4.1 エラーハンドリングの不備
**問題**: エラーログが不十分で、問題の特定が困難である。

```javascript
app.use((error, req, res, next) => {
  console.error('Unhandled error:', error);
  res.status(500).json({ error: 'サーバーエラーが発生しました' });
});
```

**影響度**: 30% - エラーの詳細が分からない
**解決策**: 詳細なエラーログの追加と監視システムの導入。

#### 3.4.2 パフォーマンス最適化
**問題**: データベース接続プールの設定が最適化されていない。

```javascript
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  // 接続プールの最適化が必要
});
```

**影響度**: 25% - レスポンス時間の遅延
**解決策**: 接続プールの最適化とクエリの改善。

## 4. 技術的背景

### 4.1 VercelのServerless Functions
Vercelは各APIルートを個別のServerless Functionとして実行する。この仕組みにより、スケーラビリティは向上するが、コールドスタートやルーティング設定に複雑性が生じる。

### 4.2 React SPAの特性
React SPAはクライアントサイドでルーティングを処理するため、サーバーサイドでのルーティング設定が必要である。直接URLアクセス時には、サーバーが適切なページを認識できない問題が発生する。

### 4.3 静的ファイル配信
Create React Appは最適化された静的ファイルを生成し、ファイル名にハッシュを含む。この仕組みにより、キャッシュバスティングは実現されるが、パスの動的生成により設定が複雑になる。

## 5. 推奨される解決策

### 5.1 即座に実行すべき修正

#### 5.1.1 Vercel設定の修正
```json
{
  "version": 2,
  "builds": [
    {
      "src": "client/package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "build"
      }
    },
    {
      "src": "api/index.js",
      "use": "@vercel/node"
    }
  ],
  "rewrites": [
    {
      "source": "/api/(.*)",
      "destination": "/api/index.js"
    },
    {
      "source": "/(.*)",
      "destination": "/client/build/index.html"
    }
  ]
}
```

#### 5.1.2 APIパスの修正
```javascript
const getApiBaseUrl = () => {
  if (process.env.NODE_ENV === 'production') {
    return window.location.origin + '/api';
  }
  return 'http://localhost:5000/api';
};
```

#### 5.1.3 React Routerの導入
```javascript
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';

function App() {
  return (
    <Router>
      <Routes>
        <Route path="/" element={<LoginPage />} />
        <Route path="/dashboard" element={<DashboardPage />} />
        <Route path="/admin" element={<AdminDashboard />} />
      </Routes>
    </Router>
  );
}
```

### 5.2 中期的な改善

#### 5.2.1 環境変数の適切な管理
- Vercelダッシュボードでの環境変数設定
- セキュアな設定管理の実装
- 環境別設定の分離

#### 5.2.2 エラーハンドリングの強化
- 詳細なエラーログの実装
- ユーザーフレンドリーなエラーメッセージ
- 監視システムの導入

### 5.3 長期的な最適化

#### 5.3.1 アーキテクチャの再設計
- マイクロサービス化の検討
- APIとクライアントの分離
- 適切な環境分離

#### 5.3.2 パフォーマンス最適化
- データベース接続の最適化
- クエリの改善
- キャッシュ戦略の実装

## 6. 結論

404エラーの根本原因は、主にVercelのルーティング設定とReact SPAの特性に起因している。最優先の修正を実施することで、90%以上のエラーが解決されることが期待される。

特に重要なのは、Vercel設定のルーティング競合の解決と、React Routerの導入である。これらの修正により、システムの安定性とユーザビリティが大幅に向上する。

今後の改善においては、環境変数の適切な管理とエラーハンドリングの強化を継続的に実施し、長期的にはアーキテクチャの最適化を検討することを推奨する。

---

**作成日**: 2024年12月
**作成者**: AI Assistant
**バージョン**: 1.0

